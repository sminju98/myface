const express = require('express');
const OpenAI = require('openai');
const path = require('path');
const fs = require('fs');
const axios = require('axios');
require('dotenv').config();

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY
});

// API í‚¤ ë¡œë”© í™•ì¸
console.log('API Key loaded:', !!process.env.OPENAI_API_KEY);
if (process.env.OPENAI_API_KEY) {
    console.log('API Key starts with:', process.env.OPENAI_API_KEY.substring(0, 10) + '...');
}

const app = express();

// JSON íŒŒì‹±ì„ ìœ„í•œ ë¯¸ë“¤ì›¨ì–´
app.use(express.json({limit: '50mb'}));

// ì •ì  íŒŒì¼ ì œê³µ
app.use(express.static(path.join(__dirname)));

// ê¸°ë³¸ ë¼ìš°íŠ¸ - index.htmlì„ ìˆ˜ì •í•˜ì—¬ API í‚¤ ì£¼ì…
app.get('/', (req, res) => {
    fs.readFile(path.join(__dirname, 'index.html'), 'utf8', (err, data) => {
        if (err) {
            console.error('Error reading index.html:', err);
            return res.status(500).send('Error loading page');
        }

        // API í‚¤ë¥¼ ì£¼ì…í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
        const modifiedHtml = data.replace(
            '</head>',
            `<script>window.OPENAI_API_KEY = "${process.env.OPENAI_API_KEY}";</script></head>`
        );

        res.send(modifiedHtml);
    });
});

// ì´ë¯¸ì§€ ë¶„ì„ ì—”ë“œí¬ì¸íŠ¸
app.post('/analyze-image', async (req, res) => {
    try {
        const { analysisType, imageData } = req.body;
        
        if (!imageData) {
            return res.status(400).json({ error: 'ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' });
        }

        const isHusband = analysisType === 'husband';

        const prompt = isHusband ? 
            "ë‹¹ì‹ ì˜ ë¯¸ë˜ì˜ ë‚¨í¸ì„ ì•Œë ¤ì£¼ëŠ” ê´€ìƒê°€ì…ë‹ˆë‹¤. í˜„ì‹¤ì ì´ë©´ì„œë„ ë‹¤ì–‘í•œ íŠ¹ì§•ì„ ê°€ì§„ ì‚¬ëŒì„ ì†Œê°œí•´ì£¼ì„¸ìš”:\n\nğŸ’¼ ì§ì—…: (IT ê°œë°œì, ê¸ˆìœµê¶Œ, êµìœ¡ê³„, ê³µë¬´ì›, ì˜ë£Œê³„, ë²•ì¡°ê³„, ê±´ì„¤/ê±´ì¶•, ë””ìì¸, ë§ˆì¼€íŒ…, ìš”ì‹ì—… ë“± í˜„ì‹¤ì ì¸ ì§ì—…ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì˜ˆ: 'ìŠ¤íƒ€íŠ¸ì—…ì—ì„œ ì•± ê°œë°œí•˜ëŠ” iOS ê°œë°œì', 'ì¦ê¶Œì‚¬ì—ì„œ ì£¼ì‹ ë¶„ì„í•˜ëŠ” ì• ë„ë¦¬ìŠ¤íŠ¸')\nğŸ‘¥ ì™¸ëª¨: (ë°˜ë“œì‹œ ë‚¨ì ì—°ì˜ˆì¸ìœ¼ë¡œë§Œ ë¹„ìœ í•´ì£¼ì„¸ìš”. ì˜ˆì‹œ: ê³µìœ , ì´ì¢…ì„, ì†¡ì¤‘ê¸°, ì°¨ì€ìš°, í˜„ë¹ˆ, ìœ ì¬ì„, ì´ìˆ˜ê·¼ ë“±ì„ ìƒí™©ì— ë§ê²Œ ì¡°í•©)\nğŸ­ MBTI: (ì„±ê²©ìœ í˜•ì„ ì¬ë¯¸ìˆëŠ” ìƒí™©ì´ë‚˜ í–‰ë™ê³¼ ì—°ê²°í•´ì„œ í‘œí˜„í•´ì£¼ì„¸ìš”)\nâœ¨ ì„±ê²©: (ì§ì—…ì´ë‚˜ MBTIì™€ ì—°ê´€ëœ ë…íŠ¹í•œ ì„±ê²©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”)\nğŸ¯ ì·¨ë¯¸: (ì§ì—…ì´ë‚˜ ì„±ê²©ê³¼ ì–´ìš¸ë¦¬ëŠ” í˜„ì‹¤ì ì´ë©´ì„œë„ ì¬ë¯¸ìˆëŠ” ì·¨ë¯¸ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”)\nğŸ’ ì—°ì•  ìŠ¤íƒ€ì¼: (ì„±ê²©ì´ë‚˜ ì·¨ë¯¸ì™€ ì—°ê´€ëœ ë…íŠ¹í•œ ì—°ì•  ìŠ¤íƒ€ì¼ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”)" :
            "ë‹¹ì‹ ì˜ ë¯¸ë˜ì˜ ì•„ë‚´ì…ë‹ˆë‹¤. í˜„ì‹¤ì ì´ë©´ì„œë„ ë‹¤ì–‘í•œ íŠ¹ì§•ì„ ê°€ì§„ ì‚¬ëŒì„ ì†Œê°œí•´ì£¼ì„¸ìš”:\n\nğŸ’¼ ì§ì—…: (IT ê°œë°œì, ê¸ˆìœµê¶Œ, êµìœ¡ê³„, ê³µë¬´ì›, ì˜ë£Œê³„, ë²•ì¡°ê³„, ê±´ì„¤/ê±´ì¶•, ë””ìì¸, ë§ˆì¼€íŒ…, ìš”ì‹ì—… ë“± í˜„ì‹¤ì ì¸ ì§ì—…ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì˜ˆ: 'ê´‘ê³ íšŒì‚¬ì—ì„œ ì¼í•˜ëŠ” í¬ë¦¬ì—ì´í‹°ë¸Œ ë””ë ‰í„°', 'ì´ˆë“±í•™êµì—ì„œ ì•„ì´ë“¤ì„ ê°€ë¥´ì¹˜ëŠ” êµì‚¬')\nğŸ‘¥ ì™¸ëª¨: (ë°˜ë“œì‹œ ì—¬ì ì—°ì˜ˆì¸ìœ¼ë¡œë§Œ ë¹„ìœ í•´ì£¼ì„¸ìš”. ì˜ˆì‹œ: ì•„ì´ìœ , ìˆ˜ì§€, í•œì†Œí¬, ì „ì§€í˜„, ì†¡í˜œêµ, ë°•ë‚˜ë˜, ì¥ë„ì—° ë“±ì„ ìƒí™©ì— ë§ê²Œ ì¡°í•©)\nğŸ­ MBTI: (ì„±ê²©ìœ í˜•ì„ ì¬ë¯¸ìˆëŠ” ìƒí™©ì´ë‚˜ í–‰ë™ê³¼ ì—°ê²°í•´ì„œ í‘œí˜„í•´ì£¼ì„¸ìš”)\nâœ¨ ì„±ê²©: (ì§ì—…ì´ë‚˜ MBTIì™€ ì—°ê´€ëœ ë…íŠ¹í•œ ì„±ê²©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”)\nğŸ¯ ì·¨ë¯¸: (ì§ì—…ì´ë‚˜ ì„±ê²©ê³¼ ì–´ìš¸ë¦¬ëŠ” í˜„ì‹¤ì ì´ë©´ì„œë„ ì¬ë¯¸ìˆëŠ” ì·¨ë¯¸ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”)\nğŸ’ ì—°ì•  ìŠ¤íƒ€ì¼: (ì„±ê²©ì´ë‚˜ ì·¨ë¯¸ì™€ ì—°ê´€ëœ ë…íŠ¹í•œ ì—°ì•  ìŠ¤íƒ€ì¼ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”)";

        console.log('Sending request to OpenAI...');
        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: [
                {
                    role: "system",
                    content: `ë‹¹ì‹ ì€ ì¬ë¯¸ìˆëŠ” ê²°í˜¼ìš´ì„¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‘ë‹µì€ ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì˜ ì´ëª¨ì§€ì™€ í•¨ê»˜ ì‘ì„±í•˜ê³ , ê° í•­ëª©ì€ ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤:

ì˜ˆì‹œ í˜•ì‹ 1:
ğŸ’¼ ì§ì—…: ì€í–‰ì´ë‚˜ ì¦ê¶Œì‚¬ì—ì„œ ì¼í•˜ëŠ” ê¸ˆìœµê¶Œ ì§ì¥ì¸
ğŸ‘¥ ì™¸ëª¨: ë©€ë¦¬ì„œ ë³´ë©´ ë¥˜ì¤€ì—´, ê°€ê¹Œì´ì„œ ë³´ë©´ ìœ ì¬ì„, ì˜†ëª¨ìŠµì€ ì°¨ì€ìš° ë‹®ìŒ
ğŸ­ MBTI: ë°¥ ë¨¹ì„ ë•Œë„ ì—‘ì…€ ì§œëŠ” ISTJ, ê°€ë” ì¦‰í¥ì ìœ¼ë¡œ ì—¬í–‰ ê°
âœ¨ ì„±ê²©: ì‹œì‹ì½”ë„ˆ í”„ë¡œ ì‹œì‹ëŸ¬, ë§›ì§‘ ì¶”ì²œë„ ì˜í•¨
ğŸ¯ ì·¨ë¯¸: ì£¼ë§ë§ˆë‹¤ ë“±ì‚° í›„ ì¹˜ë§¥, ì‚°ì—ì„œ ë§Œë‚œ ì‚¬ëŒë“¤ê³¼ íŒŒí‹°í•¨
ğŸ’ ì—°ì•  ìŠ¤íƒ€ì¼: ê¸°ë…ì¼ë§ˆë‹¤ ê¹œì§ ì´ë²¤íŠ¸ ì¤€ë¹„, ì„¤ë ˆì„œ ìŠ¤í¬í•´ë²„ë¦¼

ì˜ˆì‹œ í˜•ì‹ 2:
ğŸ’¼ ì§ì—…: ê²Œì„ì—…ê³„ì—ì„œ ì¼í•˜ëŠ” í”„ë¡œê²Œì´ë¨¸
ğŸ‘¥ ì™¸ëª¨: ë¬´í‘œì •ì¼ ë• ê³µìœ , ì›ƒì„ ë• ì´ìˆ˜ê·¼, í™”ë‚  ë• ë°•ëª…ìˆ˜ ë‹®ìŒ
ğŸ­ MBTI: ê²Œì„í•  ë• ì§„ì§€í•œ INTJ, í‰ì†Œì—” ì¥ë‚œê¾¸ëŸ¬ê¸°
âœ¨ ì„±ê²©: ê²Œì„ ì•„ì´í…œ ìˆ˜ì§‘ê´‘, ë ˆì–´ ì•„ì´í…œ íŒŒë° ì¥ì¸
ğŸ¯ ì·¨ë¯¸: PCë°©ì—ì„œ ê²Œì„ ìŠ¤íŠ¸ë¦¬ë°, íŒ¬ë“¤ê³¼ ì†Œí†µ ì˜í•¨
ğŸ’ ì—°ì•  ìŠ¤íƒ€ì¼: ê²Œì„ ì•„ì´í…œìœ¼ë¡œ ê³ ë°±, ì»¤í”Œ ê²Œì„ ì¦ê¹€

ì˜ˆì‹œ í˜•ì‹ 3:
ğŸ’¼ ì§ì—…: ITì—…ê³„ì—ì„œ ì¼í•˜ëŠ” ê°œë°œì
ğŸ‘¥ ì™¸ëª¨: ì•ˆê²½ ì“°ë©´ ê°•ë‹¤ë‹ˆì—˜, ë²—ìœ¼ë©´ ì°¨ì€ìš°, ì¼í•  ë• ë°•ëª…ìˆ˜ ë‹®ìŒ
ğŸ­ MBTI: ë²„ê·¸ ì¡ì„ ë• ISTJ, íšŒì‹ìë¦¬ì—ì„  ENFP
âœ¨ ì„±ê²©: ì½”ë“œ ì •ë¦¬ ê°•ë°•ì¦, ì•¼ê·¼í•  ë•Œ ì—ë„ˆì§€ ë“œë§í¬ í•„ìˆ˜
ğŸ¯ ì·¨ë¯¸: í‚¤ë³´ë“œ ì»¤ìŠ¤í…€ ì œì‘, ê¸°ê³„ì‹ í‚¤ë³´ë“œ ìˆ˜ì§‘
ğŸ’ ì—°ì• : ì»¤ë°‹ ë©”ì‹œì§€ì²˜ëŸ¼ ì†”ì§í•œ ê³ ë°±, ë°ì´íŠ¸ ì¼ì • ê¹ƒí—ˆë¸Œë¡œ ê´€ë¦¬

ê·œì¹™:
1. ê° í•­ëª©ì€ ë°˜ë“œì‹œ ì´ëª¨ì§€ë¡œ ì‹œì‘í•˜ê³  ì½œë¡ (:)ìœ¼ë¡œ êµ¬ë¶„
2. ì´ëª¨ì§€ì™€ í•­ëª©ëª… ì‚¬ì´ì— ë¶ˆí•„ìš”í•œ ê³µë°± ì—†ì´ ë¶™ì—¬ì„œ ì‘ì„±
3. ëª¨ë“  ë‚´ìš©ì€ ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„ë¡œ ì‘ì„±
4. ì§ì—…ì€ í•˜ë‚˜ì˜ ë¶„ì•¼ë§Œ ì„ íƒí•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…
5. ì™¸ëª¨, ì„±ê²©, ì·¨ë¯¸ëŠ” ì§ì—…ì´ë‚˜ MBTIì™€ ì—°ê´€ë˜ê²Œ ì„¤ì •
6. '~í•˜ëŠ”', '~ì ì¸' ê°™ì€ ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ ëŒ€ì‹  '~í•¨', 'ì˜í•¨' ë“± ê°„ê²°í•œ í‘œí˜„ ì‚¬ìš©
7. ì„±ê²©ê³¼ ì·¨ë¯¸ëŠ” ë…íŠ¹í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬`
                },
                {
                    role: "user",
                    content: [
                        {
                            type: "text",
                            text: prompt
                        },
                        {
                            type: "image_url",
                            image_url: {
                                "url": imageData
                            }
                        }
                    ]
                }
            ],
            max_tokens: 500,
            temperature: 0.9
        });

        console.log('Received response from OpenAI');
        
        if (!completion.choices || !completion.choices[0] || !completion.choices[0].message) {
            console.error('Invalid API response structure:', completion);
            throw new Error('API ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        const content = completion.choices[0].message.content;
        console.log('Analysis content:', content);

        // ì‘ë‹µ í˜•ì‹ ê²€ì¦ - ëª¨ë“  í•„ìˆ˜ í•­ëª©ì´ ìˆëŠ”ì§€ í™•ì¸
        const requiredElements = ['ğŸ’¼ ì§ì—…:', 'ğŸ‘¥ ì™¸ëª¨:', 'ğŸ­ MBTI:', 'âœ¨ ì„±ê²©:', 'ğŸ¯ ì·¨ë¯¸:', 'ğŸ’ ì—°ì•  ìŠ¤íƒ€ì¼:'];
        const missingElements = requiredElements.filter(element => !content.includes(element));
        
        if (missingElements.length > 0) {
            console.error('Missing required elements:', missingElements);
            throw new Error('ë¶„ì„ ê²°ê³¼ì— í•„ìˆ˜ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì§ì—… ì •ë³´ ì¶”ì¶œ
        const jobMatch = content.match(/ğŸ’¼ ì§ì—…: (.+?)(?=\n|$)/);
        if (!jobMatch) {
            console.error('Could not extract job information');
            throw new Error('ì§ì—… ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ì‘ë‹µ ì „ì†¡
        const formattedContent = content.split('\n')
            .filter(line => line.trim() !== '')
            .map(line => {
                const [emoji, ...rest] = line.split(' ');
                const label = rest[0].replace(':', '');
                const content = rest.slice(1).join(' ').trim();
                const className = label.toLowerCase() === 'mbti' ? 'mbti' : 
                                label.toLowerCase() === 'ì§ì—…' ? 'job' : '';
                
                return `<div class="result-item ${className}">
                    <div class="title-wrapper">
                        <span class="emoji">${emoji}</span>
                        <span class="label">${label}</span>
                    </div>
                    <div class="content">${content}</div>
                </div>`;
            })
            .join('\n');

        res.json({ 
            analysis: formattedContent,
            job: jobMatch[1].trim()
        });
    } catch (error) {
        console.error('Error in /analyze-image:', error);
        res.status(error.status || 500).json({ 
            error: error.message || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        });
    }
});

// ì‹¤ë£¨ì—£ ì´ë¯¸ì§€ ìƒì„± ì—”ë“œí¬ì¸íŠ¸
app.post('/generate-silhouette', async (req, res) => {
    try {
        const { analysisType } = req.body;
        const defaultImage = analysisType === 'husband' ? 'husband.png' : 'wife.png';
        res.json({ imageUrl: defaultImage });
    } catch (error) {
        console.error('Error in silhouette selection:', error);
        const defaultImage = req.body.analysisType === 'husband' ? 'husband.png' : 'wife.png';
        res.json({ imageUrl: defaultImage });
    }
});

function getJobSpecificPrompt(jobCategory) {
    switch (jobCategory) {
        case 'tech':
            return '- Include computer setup and modern tech office environment\n- Show coding or technical work pose';
        case 'medical':
            return '- Include medical equipment or hospital setting\n- Show caring or diagnostic pose';
        case 'education':
            return '- Include classroom or teaching environment\n- Show teaching or presentation pose';
        case 'creative':
            return '- Include design tools or creative studio setting\n- Show creative or artistic pose';
        case 'finance':
            return '- Include financial district office setting\n- Show analysis or presentation pose';
        case 'government':
            return '- Include official office or public service setting\n- Show administrative or service pose';
        case 'culinary':
            return '- Include kitchen or restaurant setting\n- Show cooking or food preparation pose';
        case 'legal':
            return '- Include law office or courtroom setting\n- Show counseling or presentation pose';
        default:
            return '- Include modern office setting\n- Show professional working pose';
    }
}

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log("Server is running at http://localhost:" + PORT);
}); 